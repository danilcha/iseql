#!/bin/bash

set -e


source ./common.inc.sh


if [ ! "$1" ]
then
    echo "ARGUMENTS: <experiment suite name>"
    exit 1
fi

RESULTS_DIR="$SCRIPT_DIR/results/$1"
mkdir -p "$RESULTS_DIR"



DISABLED_EXPERIMENTS=''

resetDisabledExperiments()
{
    DISABLED_EXPERIMENTS='-'
}


disableLongExperiments()
{
    local DATA=`cat "$1" | grep -B 2 -- '-----END RESULTS-----' | head -n 2`
    local experiments=(`echo "$DATA" | head -n 1`)
    local values=(`echo "$DATA" | tail -n 1`)

    resetDisabledExperiments

    for i in `seq 0 $((${#experiments[*]} - 1))`
    do
        local experiment=${experiments[$i]}
        local time=${values[$i]}
        if [[ "$time" == 'nan' ]] || (( $(bc <<< "$time > 1000") ))
        then
            if [ "$DISABLED_EXPERIMENTS" == '-' ]
            then
                DISABLED_EXPERIMENTS="$experiment"
            else
                DISABLED_EXPERIMENTS="$DISABLED_EXPERIMENTS,$experiment"
            fi
        fi
    done
}



experiment()
{
    NAME="$1"
    RESULT_FILE="$RESULTS_DIR/$NAME.txt"
    if [ ! -f "$RESULT_FILE" ]
    then

        #echo "Skipping because $RESULT_FILE exists"
#	else
        echo '---------------------------------------------------------------------------------------'
        echo experiment "${@}"
        echo '---------------------------------------------------------------------------------------'

        "$EXE" "${@:2}" "$DISABLED_EXPERIMENTS" | tee "$RESULTS_DIR/current.txt"
        mv "$RESULTS_DIR/current.txt" "$RESULT_FILE"
    fi

    disableLongExperiments "$RESULT_FILE"
}


EXPERIMENTS_PREFIX=""

experiments()
{
    experiment "$EXPERIMENTS_PREFIX$1"-reverse-during  reverse-during  "${@:2}"
    experiment "$EXPERIMENTS_PREFIX$1"-start-preceding start-preceding "${@:2}"
    experiment "$EXPERIMENTS_PREFIX$1"-left-overlap    left-overlap    "${@:2}"
}


exp-suite()
{
    resetDisabledExperiments
    for c in 1e3 3.16e3 1e4 3.16e4 1e5 3.16e5 1e6 3.16e6 1e7 3.16e7 1e8 # 3.16e8 1e9
    do
    #	for l in 1e1 1e2 1e3 1e4 1e5 1e6
        for l in 1e2 1e4 1e6
        do
            if [[ "$c" == "3.16e6" && ("$l" == "1e6") ]]
            then
                continue
            fi
            if [[ "$c" == "1e7"    && ("$l" == "1e5" || "$l" == "1e6") ]]
            then
                continue
            fi
            if [[ "$c" == "3.16e7" && ("$l" == "1e4" || "$l" == "1e5" || "$l" == "1e6") ]]
            then
                continue
            fi
            if [[ "$c" == "1e8"    && ("$l" == "1e3" || "$l" == "1e4" || "$l" == "1e5" || "$l" == "1e6") ]]
            then
                continue
            fi
            if [[ "$c" == "3.16e8" && ("$l" == "1e2" || "$l" == "1e3" || "$l" == "1e4" || "$l" == "1e5" || "$l" == "1e6") ]]
            then
                continue
            fi

            experiments "exp-$c-$l" --exp $c $l --exp $c $l
        done
    done
}

rw-suite()
{
    experiments rw-flight  --file "$DATA_DIR/FLIGHTS_DATA_TABLE.txt"  --file "$DATA_DIR/FLIGHTS_DATA_TABLE.txt"
    experiments rw-inc     --file "$DATA_DIR/incumbent-norm.txt"      --file "$DATA_DIR/incumbent-norm.txt"
    experiments rw-wi      --file "$DATA_DIR/webkit-norm.txt"         --file "$DATA_DIR/incumbent-norm.txt"
    experiments rw-bi      --file "$DATA_DIR/big_table-norm.txt"      --file "$DATA_DIR/incumbent-norm.txt"
    experiments rw-web     --file "$DATA_DIR/webkit-norm.txt"         --file "$DATA_DIR/webkit-norm.txt"
    experiments rw-big     --file "$DATA_DIR/big_table-norm.txt"      --file "$DATA_DIR/big_table-norm.txt"
    experiments rw-basf    --basf "$DATA_DIR/basf_nono.import"        --basf "$DATA_DIR/basf_nono.import"
}


exp-suite

rw-suite

switchToCounters
EXPERIMENTS_PREFIX="counters-"

rw-suite

switchToEBI
EXPERIMENTS_PREFIX="ebi-"

rw-suite

